# IPC Handler Tests Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Add deterministic regression tests for Electron IPC handlers so future refactors can safely change internals without breaking channel behavior.

**Architecture:** Test `initializeIpcHandlers` as a pure registration function by mocking `electron` and injecting fake `IIpcHandlerDeps`. Capture channel callbacks from `ipcMain.handle`, invoke them directly, and assert return contracts and side effects. Keep production changes minimal and only when tests reveal real defects.

**Tech Stack:** TypeScript, Vitest, Electron IPC mocks, npm.

---

### Task 1: Build IPC test harness

**Files:**
- Create: `tests/electron/helpers/ipcHarness.ts`
- Test: `tests/electron/ipcHandlers.test.ts`

**Step 1: Write the failing test**

```ts
import { describe, expect, it } from "vitest"

describe("ipc harness", () => {
  it("captures handlers registered through ipcMain.handle", () => {
    expect(false).toBe(true)
  })
})
```

**Step 2: Run test to verify it fails**

Run: `npm run test -- tests/electron/ipcHandlers.test.ts`
Expected: FAIL at the placeholder assertion.

**Step 3: Write minimal implementation**

Create harness utility that:

- mocks `electron` module,
- records `ipcMain.handle(channel, handler)` registrations,
- exposes `invoke(channel, ...args)` helper.

Example shape:

```ts
export type IpcHandler = (...args: unknown[]) => unknown

export const handlers = new Map<string, IpcHandler>()

export const invoke = async (channel: string, ...args: unknown[]) => {
  const handler = handlers.get(channel)
  if (!handler) throw new Error(`Missing handler: ${channel}`)
  return await handler({}, ...args)
}
```

**Step 4: Run test to verify it passes**

Run: `npm run test -- tests/electron/ipcHandlers.test.ts`
Expected: PASS for harness sanity checks.

**Step 5: Commit**

```bash
git add tests/electron/helpers/ipcHarness.ts tests/electron/ipcHandlers.test.ts
git commit -m "test: add IPC handler test harness"
```

---

### Task 2: Cover screenshot and processing channels

**Files:**
- Modify: `tests/electron/ipcHandlers.test.ts`

**Step 1: Write failing tests**

Add tests for:

- `get-screenshots` returns queue previews for `view=queue`.
- `delete-last-screenshot` returns no-screenshot error on empty queue.
- `trigger-process-screenshots` returns API-key-required payload when key missing.

Example:

```ts
it("returns API key required when trigger-process-screenshots without key", async () => {
  configHelper.hasApiKey.mockReturnValue(false)
  const result = await invoke("trigger-process-screenshots")
  expect(result).toEqual({ success: false, error: "API key required" })
})
```

**Step 2: Run test to verify it fails**

Run: `npm run test -- tests/electron/ipcHandlers.test.ts`
Expected: FAIL before stubs/fixtures are complete.

**Step 3: Write minimal implementation**

Add fixture deps and config helper mocks required for these assertions; avoid production edits unless behavior bug is discovered.

**Step 4: Run test to verify it passes**

Run: `npm run test -- tests/electron/ipcHandlers.test.ts`
Expected: PASS for added screenshot/processing cases.

**Step 5: Commit**

```bash
git add tests/electron/ipcHandlers.test.ts
git commit -m "test: cover screenshot and processing IPC handlers"
```

---

### Task 3: Cover conversation and transcription channels

**Files:**
- Modify: `tests/electron/ipcHandlers.test.ts`

**Step 1: Write failing tests**

Add tests for:

- `add-conversation-message` normalizes invalid speaker to undefined.
- `get-conversation` returns `{ success: false, messages: [] }` when manager missing.
- `toggle-speaker` returns manager-not-initialized error when missing.
- `transcribe-audio` returns fallback message when helper throws non-Error.

Example:

```ts
it("returns fallback transcription error for unknown throw", async () => {
  deps.transcriptionHelper.transcribeAudio.mockRejectedValue("boom")
  const result = await invoke("transcribe-audio", new ArrayBuffer(8), "audio/webm")
  expect(result).toEqual({ success: false, error: "Transcription failed" })
})
```

**Step 2: Run test to verify it fails**

Run: `npm run test -- tests/electron/ipcHandlers.test.ts`
Expected: FAIL for the new coverage cases.

**Step 3: Write minimal implementation**

Adjust only test fixtures/mocks needed; only touch production code if a true contract mismatch is exposed.

**Step 4: Run test to verify it passes**

Run: `npm run test -- tests/electron/ipcHandlers.test.ts`
Expected: PASS for conversation/transcription cases.

**Step 5: Commit**

```bash
git add tests/electron/ipcHandlers.test.ts
git commit -m "test: add conversation and transcription IPC coverage"
```

---

### Task 4: Cover external-link alias and window command channels

**Files:**
- Modify: `tests/electron/ipcHandlers.test.ts`

**Step 1: Write failing tests**

Add tests for:

- `open-external-url`, `openLink`, and `openExternal` all call `shell.openExternal` with same URL.
- `trigger-move-left/right/up/down` return `{ success: true }` when deps succeed.
- movement handlers return error payload when dep throws.

**Step 2: Run test to verify it fails**

Run: `npm run test -- tests/electron/ipcHandlers.test.ts`
Expected: FAIL until alias and command assertions are wired.

**Step 3: Write minimal implementation**

Use shared command test helper inside test file to reduce duplication.

```ts
const expectSuccessCommand = async (channel: string, spy: Mock) => {
  const result = await invoke(channel)
  expect(spy).toHaveBeenCalledTimes(1)
  expect(result).toEqual({ success: true })
}
```

**Step 4: Run test to verify it passes**

Run: `npm run test -- tests/electron/ipcHandlers.test.ts`
Expected: PASS for alias and window command tests.

**Step 5: Commit**

```bash
git add tests/electron/ipcHandlers.test.ts
git commit -m "test: verify external link aliases and window command handlers"
```

---

### Task 5: Full project verification

**Files:**
- Verify-only: all updated test and helper files

**Step 1: Run full test suite**

Run: `npm run test`
Expected: PASS.

**Step 2: Run quality/build gates**

Run:

- `npm run lint`
- `npm run typecheck`
- `npm run build`

Expected: all PASS.

**Step 3: Final commit if needed**

```bash
git add .
git commit -m "chore: verify quality gates after IPC test coverage"
```

Only if any last-minute adjustments were needed.

---

## Notes for execution

- Keep tests deterministic and independent.
- Prefer asserting public channel contracts, not implementation internals.
- If a failing test reveals a real bug, use `@superpowers:systematic-debugging` before changing production behavior.
- Before claiming completion, use `@superpowers:verification-before-completion` and report exact command results.
